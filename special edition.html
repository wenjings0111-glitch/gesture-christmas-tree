<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3D Magic Christmas World</title>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; transition: background 1.5s ease; }
        
        /* åŠ¨æ€èƒŒæ™¯é£æ ¼ */
        body.bg-black { background: #000; }
        body.bg-deep { background: radial-gradient(circle at center, #0a1128 0%, #000 100%); }
        body.bg-warm { background: radial-gradient(circle at center, #2b1010 0%, #050101 100%); }
        body.bg-aurora { background: linear-gradient(to bottom, #004e92, #000428); }

        #main-title {
            position: absolute; top: 15px; width: 100%; text-align: center;
            font-family: 'Great Vibes', cursive; font-size: clamp(2.5rem, 7vw, 4rem);
            background: linear-gradient(to bottom, #ffd700, #fff);
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent; z-index: 50; pointer-events: none;
        }

        #start-screen {
            position: absolute; inset: 0; background: #000; z-index: 200;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff;
        }
        #btn-start {
            padding: 15px 50px; font-size: 22px; background: linear-gradient(90deg, #ffd700, #ffaa00);
            border: none; border-radius: 50px; color: #000; font-weight: bold; cursor: pointer; margin-top: 20px;
        }

        #ui-panel {
            position: fixed; top: 80px; right: 20px; width: 260px; background: rgba(0,0,0,0.85);
            padding: 20px; border-radius: 15px; color: #fff; z-index: 100; transform: translateX(320px); transition: 0.5s;
            backdrop-filter: blur(10px); border: 1px solid rgba(255,215,0,0.3);
        }
        #ui-panel.show { transform: translateX(0); }
        
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; margin-bottom: 8px; font-size: 14px; color: #ffd700; }
        select, input[type=range] { width: 100%; padding: 8px; background: #222; color: #fff; border: 1px solid #444; border-radius: 5px; }

        #photo-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            max-width: 80vw; padding: 10px; background: #fff; border-radius: 10px; z-index: 150; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #photo-modal.active { transform: translate(-50%, -50%) scale(1); }
        #photo-modal img { width: 100%; border-radius: 5px; display: block; }

        #input_video { position: fixed; bottom: 10px; left: 10px; width: 120px; height: 90px; border-radius: 8px; border: 1px solid #ffd700; z-index: 90; }
        #toggle-ui { position: fixed; top: 20px; right: 20px; z-index: 101; font-size: 24px; cursor: pointer; background:none; border:none; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body class="bg-black">

    <div id="main-title">Merry Christmas</div>
    
    <div id="start-screen">
        <h1 style="font-family:'Great Vibes'; font-size: 4rem; color:#ffd700;">Winter Magic</h1>
        <p>å¼€å¯æ‘„åƒå¤´ï¼Œç”¨åŒæ‰‹æ“æ§åœ£è¯é­”æ³•</p>
        <button id="btn-start">è¿›å…¥ 3D å†°é›ªä¸–ç•Œ</button>
    </div>

    <div id="photo-modal"><img id="modal-img" src=""></div>
    
    <button id="toggle-ui">âš™ï¸</button>
    <div id="ui-panel">
        <h3 style="margin-top:0; color:#ffd700;">ğŸ„ é­”æ³•è®¾ç½®</h3>
        
        <div class="control-group">
            <label>åœºæ™¯é£æ ¼</label>
            <select id="bg-select">
                <option value="black">ğŸŒŒ çº¯é»‘ (Black)</option>
                <option value="deep">ğŸŒƒ æ·±é‚ƒ (Deep Blue)</option>
                <option value="warm">ğŸ”¥ æš–å†¬ (Warm)</option>
                <option value="aurora">â„ï¸ æå…‰ (Aurora)</option>
            </select>
        </div>

        <div class="control-group">
            <label>åœ£è¯èƒŒæ™¯éŸ³ä¹</label>
            <div style="display:flex; gap:10px;">
                <button id="btn-play" style="flex:1; padding:8px; cursor:pointer;">â–¶ æ’­æ”¾/æš‚åœ</button>
                <input type="range" id="vol-slider" min="0" max="1" step="0.1" value="0.5" style="width:60px;">
            </div>
        </div>

        <div class="control-group">
            <label>å¯¼å…¥ç…§ç‰‡äº‘</label>
            <button onclick="document.getElementById('file-in').click()" style="width:100%; padding:8px; cursor:pointer; background:#ffd700; border:none; border-radius:5px; font-weight:bold;">ğŸ“· é€‰æ‹©å¤šå¼ ç…§ç‰‡</button>
            <input type="file" id="file-in" multiple accept="image/*" style="display:none;">
        </div>
    </div>

    <video id="input_video" style="display:none;"></video>

    <script>
        let scene, camera, renderer, treeGroup, star, snowSystem, audio;
        let decorMeshes = [], loadedImages = [];
        const state = { explosion: 0, targetExplosion: 0, treeHeight: 75, photoActive: false };

        // éŸ³ä¹åˆå§‹åŒ–
        audio = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3'); // å ä½ç¬¦ï¼Œå¯æ›´æ¢ä¸ºåœ£è¯æ›²
        audio.loop = true;

        document.getElementById('btn-start').onclick = () => {
            document.getElementById('start-screen').style.display = 'none';
            initThree();
            startTracking();
            audio.play().catch(() => console.log("ç­‰å¾…äº¤äº’æ’­æ”¾éŸ³ä¹"));
        };

        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 40, 120);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const ambient = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambient);
            const light = new THREE.PointLight(0xffd700, 1.2, 300);
            light.position.set(0, 100, 50);
            scene.add(light);

            treeGroup = new THREE.Group();
            scene.add(treeGroup);

            createTree();
            createStar();
            createSnow(); // åˆå§‹åŒ–é›ªèŠ±
            setupUIEvents();
            animate();
        }

        // åŠ¨æ€é›ªèŠ±ç³»ç»Ÿ
        function createSnow() {
            const snowCount = 2000;
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for (let i = 0; i < snowCount; i++) {
                pos.push(Math.random() * 400 - 200, Math.random() * 400 - 200, Math.random() * 400 - 200);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            const mat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.8, transparent: true, opacity: 0.8 });
            snowSystem = new THREE.Points(geo, mat);
            scene.add(snowSystem);
        }

        function createTree() {
            decorMeshes.forEach(m => treeGroup.remove(m));
            decorMeshes = [];
            const h = state.treeHeight;
            const count = 400;
            
            // æ··åˆå‡ ä½•ä½“ï¼šåœ†çƒã€æ­£æ–¹ä½“
            const geometries = [new THREE.SphereGeometry(1.2, 12, 12), new THREE.BoxGeometry(1.5, 1.5, 1.5)];
            const colors = [0xff4444, 0x44ff44, 0xffd700, 0xffffff, 0x44aaff];

            for (let i = 0; i < count; i++) {
                const y = (i / count) * h;
                const r = (1 - y / h) * (h * 0.4) * (0.8 + Math.random() * 0.4);
                const angle = i * 0.3;
                
                const mesh = new THREE.Mesh(
                    geometries[i % 2],
                    new THREE.MeshPhongMaterial({ color: colors[i % colors.length], shininess: 80 })
                );
                mesh.position.set(Math.cos(angle) * r, y - 30, Math.sin(angle) * r);
                mesh.userData = { origin: mesh.position.clone(), explode: mesh.position.clone().normalize().multiplyScalar(60 + Math.random() * 40) };
                treeGroup.add(mesh);
                decorMeshes.push(mesh);
            }
        }

        function createStar() {
            if(star) treeGroup.remove(star);
            const shape = new THREE.Shape();
            for(let i=0; i<10; i++){
                let r = i%2==0 ? 6 : 2.5; let a = Math.PI*2*i/10;
                if(i==0) shape.moveTo(Math.cos(a)*r, Math.sin(a)*r); else shape.lineTo(Math.cos(a)*r, Math.sin(a)*r);
            }
            star = new THREE.Mesh(new THREE.ExtrudeGeometry(shape, {depth:2, bevelEnabled:true}), new THREE.MeshPhongMaterial({color:0xffd700}));
            star.position.y = state.treeHeight - 25;
            treeGroup.add(star);
        }

        function setupUIEvents() {
            document.getElementById('toggle-ui').onclick = () => document.getElementById('ui-panel').classList.toggle('show');
            document.getElementById('bg-select').onchange = (e) => document.body.className = 'bg-' + e.target.value;
            document.getElementById('btn-play').onclick = () => audio.paused ? audio.play() : audio.pause();
            document.getElementById('vol-slider').oninput = (e) => audio.volume = e.target.value;
            
            document.getElementById('file-in').onchange = (e) => {
                Array.from(e.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const img = new Image(); img.src = ev.target.result;
                        loadedImages.push(img);
                        // åˆ›å»ºç…§ç‰‡å¡ç‰‡
                        const tex = new THREE.TextureLoader().load(img.src);
                        const mesh = new THREE.Mesh(new THREE.PlaneGeometry(10, 10), new THREE.MeshBasicMaterial({map:tex, side:2}));
                        const y = Math.random()*state.treeHeight - 20;
                        mesh.position.set(Math.random()*40-20, y, Math.random()*40-20);
                        mesh.userData = {origin: mesh.position.clone(), explode: mesh.position.clone().normalize().multiplyScalar(100), isPhoto:true};
                        treeGroup.add(mesh); decorMeshes.push(mesh);
                    };
                    reader.readAsDataURL(file);
                });
            };
        }

        function startTracking() {
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5 });
            hands.onResults(results => {
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const lm = results.multiHandLandmarks[0];
                    // çˆ†ç‚¸é€»è¾‘ï¼šæ‹‡æŒ‡ä¸å°æŒ‡è·ç¦»
                    const d = Math.hypot(lm[4].x - lm[20].x, lm[4].y - lm[20].y);
                    state.targetExplosion = Math.min(Math.max((d - 0.15) * 3, 0), 1);
                    
                    // ç…§ç‰‡å¼¹å‡ºï¼šé£ŸæŒ‡ä¸æ‹‡æŒ‡æåˆ
                    const pinch = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                    if(pinch < 0.04 && !state.photoActive && loadedImages.length > 0) {
                        document.getElementById('modal-img').src = loadedImages[Math.floor(Math.random()*loadedImages.length)].src;
                        document.getElementById('photo-modal').classList.add('active');
                        state.photoActive = true;
                    } else if(pinch > 0.1) {
                        document.getElementById('photo-modal').classList.remove('active');
                        state.photoActive = false;
                    }
                }
            });
            new Camera(document.getElementById('input_video'), {
                onFrame: async () => { await hands.send({image: document.getElementById('input_video')}); },
                width: 640, height: 480
            }).start();
        }

        function animate() {
            requestAnimationFrame(animate);
            state.explosion += (state.targetExplosion - state.explosion) * 0.1;
            
            // è£…é¥°å“çˆ†ç‚¸ä¸æ—‹è½¬
            decorMeshes.forEach(m => {
                m.position.lerpVectors(m.userData.origin, m.userData.explode, state.explosion);
                if(m.userData.isPhoto) m.lookAt(camera.position);
                else { m.rotation.x += 0.01; m.rotation.y += 0.01; }
            });

            // æ˜Ÿæ˜Ÿå¾‹åŠ¨
            if(star) { star.rotation.y += 0.02; star.scale.setScalar(1 + Math.sin(Date.now()*0.003)*0.1); }

            // é›ªèŠ±é£˜è½é€»è¾‘
            if(snowSystem) {
                const positions = snowSystem.geometry.attributes.position.array;
                for(let i=1; i<positions.length; i+=3) {
                    positions[i] -= 0.5; // ä¸‹è½é€Ÿåº¦
                    if(positions[i] < -200) positions[i] = 200;
                }
                snowSystem.geometry.attributes.position.needsUpdate = true;
            }

            treeGroup.rotation.y += 0.005 + state.explosion * 0.02;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
