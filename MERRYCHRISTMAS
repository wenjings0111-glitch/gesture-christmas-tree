<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Merry Christmas - Single Hand Magic</title>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; transition: background 1s ease; }
        body.bg-black { background: #000; }
        body.bg-deep { background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%); }
        body.bg-warm { background: radial-gradient(circle at center, #2e1a1a 0%, #0f0505 100%); }
        body.bg-aurora { background: radial-gradient(circle at top, #0f2027 0%, #203a43 50%, #2c5364 100%); }

        #main-title {
            position: absolute; top: 10px; left: 0; width: 100%;
            text-align: center; font-family: 'Great Vibes', cursive;
            font-size: clamp(2rem, 8vw, 5rem); z-index: 50; pointer-events: none; opacity: 0; transition: opacity 2s;
            background: linear-gradient(to bottom, #ffd700, #ffec8b);
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent; color: transparent;
            text-shadow: 0 0 20px rgba(255,215,0,0.3);
        }

        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 200; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: #fff;
        }
        #btn-start {
            padding: 18px 60px; font-size: clamp(18px, 5vw, 24px); background: linear-gradient(90deg, #ffd700, #ffaa00);
            border: none; border-radius: 30px; color: #000; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3); margin-top: 30px; transition: transform 0.2s;
        }

        #photo-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5);
            max-width: min(90vw, 500px); max-height: min(80vh, 600px); 
            background: #fff; padding: 15px 15px 50px 15px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8); z-index: 150;
            opacity: 0; pointer-events: none; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-radius: 8px;
        }
        #photo-modal.active { opacity: 1; transform: translate(-50%, -50%) scale(1) rotate(-3deg); pointer-events: auto; }
        #photo-modal img { max-width: 100%; max-height: min(60vh, 500px); display: block; border-radius: 4px; }
        #photo-caption { text-align: center; color: #333; font-family: 'Great Vibes', cursive; font-size: 1.5rem; margin-top: 10px; }

        #status-bar {
            position: absolute; bottom: 10px; width: 100%; text-align: center;
            color: rgba(255,255,255,0.7); font-size: 14px; z-index: 95; pointer-events: none;
        }

        #ui-panel {
            position: fixed; top: 60px; right: 10px; width: 260px; max-height: 80vh; overflow-y: auto;
            background: rgba(15, 15, 20, 0.9); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 12px; color: #fff; z-index: 100; transition: 0.4s;
        }
        #ui-panel.hidden { transform: translateX(120%); }
        .control-group { margin-bottom: 12px; }
        .btn { width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 8px; cursor: pointer; margin-top: 5px; }

        #toggle-btn { position: fixed; top: 10px; right: 10px; width: 44px; height: 44px; background: rgba(255,255,255,0.1); border-radius: 50%; color: #fff; z-index: 101; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; }
        #input_video { position: fixed; bottom: 10px; left: 10px; width: 120px; height: 90px; border-radius: 8px; border: 2px solid #fff; z-index: 90; object-fit: cover; }
        .hidden-cam { display: none; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body class="bg-black">

    <div id="main-title">Merry Christmas</div>
    <div id="status-bar">å‡†å¤‡å¼€å§‹é­”æ³•...</div>

    <div id="start-screen">
        <h1 style="font-family: 'Great Vibes'; font-size: 4rem; color: #ffd700; margin: 0;">Single Hand Magic</h1>
        <p style="color: #888; text-align: center; padding: 0 20px;">ğŸ–ï¸ å¼ å¼€/æ¡æ‹³ï¼šçˆ†ç‚¸è¿˜åŸ<br>ğŸ‘Œ æåˆï¼šå¼¹å‡ºç…§ç‰‡<br>â†•ï¸ ä¸Šä¸‹ç§»åŠ¨ï¼šæ§åˆ¶æ ‘é«˜</p>
        <button id="btn-start">å¼€å¯é­”æ³• âœ¨</button>
    </div>

    <div id="photo-modal">
        <img id="modal-img" src="" alt="Memory">
        <div id="photo-caption">Sweet Memory</div>
    </div>

    <button id="toggle-btn">âš™ï¸</button>
    <video id="input_video" class="hidden-cam"></video>

    <div id="ui-panel" class="hidden">
        <h3 style="color:#ffd700; margin-top:0;">ğŸ„ è®¾ç½®é¢æ¿</h3>
        <div class="control-group">
            <button class="btn" onclick="document.getElementById('folder-input').click()">ğŸ“· å¯¼å…¥è®°å¿†ç…§ç‰‡ (å¤šé€‰)</button>
            <input type="file" id="folder-input" multiple accept="image/*" style="display:none;">
        </div>
        <div class="control-group">
            <label>åœºæ™¯é£æ ¼</label>
            <select id="bg-select" class="btn" style="background:#222">
                <option value="black">ğŸŒŒ çº¯é»‘</option>
                <option value="deep">ğŸŒƒ æ·±é‚ƒ</option>
                <option value="warm">ğŸ”¥ æš–å†¬</option>
                <option value="aurora">â„ï¸ æå…‰</option>
            </select>
        </div>
        <div class="control-group">
            <button id="btn-toggle-cam" class="btn">ğŸ“¹ æ˜¾ç¤º/éšè—é¢„è§ˆ</button>
        </div>
    </div>

    <script type="x-shader/x-vertex" id="vertexshader">
        attribute float size;
        attribute vec3 customColor;
        attribute vec3 spherePos;
        attribute float type;
        varying vec3 vColor;
        uniform float uExplosion;
        uniform float uBeat;
        void main() {
            vColor = customColor;
            float t = uExplosion;
            float ease = 1.0 - pow(1.0 - t, 3.0);
            vec3 finalPos = mix(position, spherePos, ease);
            vec4 mvPosition = modelViewMatrix * vec4(finalPos * (1.0 + uBeat * 0.1), 1.0);
            gl_PointSize = size * (300.0 / -mvPosition.z);
            gl_Position = projectionMatrix * mvPosition;
        }
    </script>
    <script type="x-shader/x-fragment" id="fragmentshader">
        varying vec3 vColor;
        void main() {
            if(length(gl_PointCoord - vec2(0.5)) > 0.5) discard;
            gl_FragColor = vec4(vColor, 1.0);
        }
    </script>

    <script>
        const state = { explosion: 0, targetExplosion: 0, photoActive: false, treeHeight: 70, rotationSpeed: 0.005, uniforms: null };
        let scene, camera, renderer, clock, treeGroup, particleSystem, starMesh, snowSystem, loadedImages = [], photoMeshes = [];
        let audioCtx, analyser, dataArray, audioEl;

        document.getElementById('btn-start').addEventListener('click', () => {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('main-title').style.opacity = 1;
            initAudio();
            initThree();
            startTracking();
        });

        function initAudio() {
            audioEl = new Audio("https://thirdparty.gtimg.com/C1000007bNrR1HXkjD.m4a?fromtag=38");
            audioEl.loop = true;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            const source = audioCtx.createMediaElementSource(audioEl);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            audioEl.play();
        }

        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 30, 90);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            treeGroup = new THREE.Group();
            scene.add(treeGroup);
            createParticles();
            createStar();
            createSnow();
            animate();
        }

        function createParticles() {
            if(particleSystem) treeGroup.remove(particleSystem);
            const count = 12000, geo = new THREE.BufferGeometry();
            const pos = [], sPos = [], col = [], sizes = [];
            for(let i=0; i<count; i++) {
                const y = (i/count) * state.treeHeight;
                const r = (1 - y/state.treeHeight) * (state.treeHeight * 0.4) * Math.sqrt(Math.random());
                const a = i * 0.2;
                pos.push(Math.cos(a)*r, y - 20, Math.sin(a)*r);
                const v = new THREE.Vector3(Math.random()-0.5, Math.random()-0.5, Math.random()-0.5).normalize().multiplyScalar(60);
                sPos.push(v.x, v.y + 20, v.z);
                col.push(0.1, 0.8, 0.2); sizes.push(Math.random() * 2 + 1);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            geo.setAttribute('spherePos', new THREE.Float32BufferAttribute(sPos, 3));
            geo.setAttribute('customColor', new THREE.Float32BufferAttribute(col, 3));
            geo.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));
            state.uniforms = { uExplosion: { value: 0 }, uBeat: { value: 0 } };
            const mat = new THREE.ShaderMaterial({ uniforms: state.uniforms, vertexShader: document.getElementById('vertexshader').textContent, fragmentShader: document.getElementById('fragmentshader').textContent, blending: THREE.AdditiveBlending, transparent: true });
            particleSystem = new THREE.Points(geo, mat);
            treeGroup.add(particleSystem);
        }

        function createStar() {
            const shape = new THREE.Shape();
            for(let i=0; i<10; i++) {
                const r = i%2==0 ? 5 : 2, a = Math.PI * i / 5;
                if(i==0) shape.moveTo(Math.cos(a)*r, Math.sin(a)*r); else shape.lineTo(Math.cos(a)*r, Math.sin(a)*r);
            }
            starMesh = new THREE.Mesh(new THREE.ShapeGeometry(shape), new THREE.MeshBasicMaterial({color: 0xffd700}));
            starMesh.position.y = state.treeHeight - 15;
            treeGroup.add(starMesh);
        }

        function createSnow() {
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<1000; i++) pos.push((Math.random()-0.5)*200, Math.random()*100, (Math.random()-0.5)*200);
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            snowSystem = new THREE.Points(geo, new THREE.PointsMaterial({color: 0xffffff, size: 0.5}));
            scene.add(snowSystem);
        }

        function startTracking() {
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5 });
            hands.onResults(results => {
                const status = document.getElementById('status-bar');
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const lm = results.multiHandLandmarks[0];
                    const openDist = Math.hypot(lm[4].x - lm[20].x, lm[4].y - lm[20].y);
                    state.targetExplosion = Math.min(Math.max((openDist - 0.1) * 3, 0), 1);
                    const pinchDist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                    
                    // å•æ‰‹ä¸Šä¸‹æ§åˆ¶æ ‘é«˜
                    const handY = 1.0 - lm[9].y;
                    const newHeight = 40 + (handY * 60);
                    if(Math.abs(newHeight - state.treeHeight) > 5) {
                        state.treeHeight = newHeight;
                        createParticles();
                        if(starMesh) starMesh.position.y = state.treeHeight - 15;
                    }

                    if (pinchDist < 0.04) {
                        if (!state.photoActive && loadedImages.length > 0) {
                            const img = loadedImages[Math.floor(Math.random()*loadedImages.length)];
                            document.getElementById('modal-img').src = img.src;
                            document.getElementById('photo-modal').classList.add('active');
                            state.photoActive = true;
                        }
                        status.innerText = "ğŸ‘Œ è®°å¿†æå–ä¸­...";
                    } else {
                        if (state.photoActive) { document.getElementById('photo-modal').classList.remove('active'); state.photoActive = false; }
                        status.innerText = state.targetExplosion > 0.5 ? "ğŸ–ï¸ çˆ†å‘è®°å¿†ï¼" : "âœ‹ å‡èšé­”åŠ›";
                    }
                } else {
                    state.targetExplosion = 0; status.innerText = "ğŸ‘€ ç­‰å¾…æ‰‹åŠ¿...";
                }
            });
            const camera = new Camera(document.getElementById('input_video'), { onFrame: async () => { await hands.send({image: document.getElementById('input_video')}); }, width: 640, height: 480 });
            camera.start();
        }

        function animate() {
            requestAnimationFrame(animate);
            let beat = 0;
            if(analyser) {
                analyser.getByteFrequencyData(dataArray);
                beat = dataArray[0] / 255;
            }
            if(state.uniforms) {
                state.explosion += (state.targetExplosion - state.explosion) * 0.1;
                state.uniforms.uExplosion.value = state.explosion;
                state.uniforms.uBeat.value = beat;
            }
            treeGroup.rotation.y += state.rotationSpeed + state.explosion * 0.02;
            if(snowSystem) {
                const pos = snowSystem.geometry.attributes.position.array;
                for(let i=1; i<pos.length; i+=3) { pos[i] -= 0.2; if(pos[i]<0) pos[i]=100; }
                snowSystem.geometry.attributes.position.needsUpdate = true;
            }
            renderer.render(scene, camera);
        }

        // UI é€»è¾‘
        document.getElementById('toggle-btn').onclick = () => document.getElementById('ui-panel').classList.toggle('hidden');
        document.getElementById('bg-select').onchange = (e) => document.body.className = 'bg-' + e.target.value;
        document.getElementById('btn-toggle-cam').onclick = () => document.getElementById('input_video').classList.toggle('hidden-cam');
        document.getElementById('folder-input').onchange = (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (ev) => { const img = new Image(); img.src = ev.target.result; loadedImages.push(img); };
                reader.readAsDataURL(file);
            });
            alert("ç…§ç‰‡å·²è½½å…¥ï¼Œå°è¯•æåˆæ‰‹åŠ¿æå–ï¼");
        };
    </script>
</body>
</html>
